<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel è¬èƒ½å·¥å…·ç®± - å…§å»ºé›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        .tab.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f8fbff; }
        .field-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; }
        .row .field-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .checkbox-group input { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
        .info-box { background: #e8f4fd; color: #2c3e50; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; border-left: 4px solid #3498db; white-space: pre-line; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #444; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; white-space: pre-line; min-height: 40px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“Š Excel è¬èƒ½å·¥å…·ç®±</h2>
    
    <div class="tabs">
        <div class="tab active" onclick="switchMode('split')">âœ‚ï¸ åˆ†å‰²/åˆä½µ</div>
        <div class="tab" onclick="switchMode('transform')">ğŸ”„ æ ¼å¼è½‰æ›</div>
        <div class="tab" onclick="switchMode('proxy')">ğŸŒ ä»£ç†åˆ†é…</div>
    </div>
    
    <div id="commonUpload" class="field-group">
        <label>1. ä¸Šå‚³æª”æ¡ˆ (å¯å¤šé¸)</label>
        <input type="file" id="upload" accept=".xlsx, .xls" multiple />
    </div>

    <div id="proxyUpload" class="field-group" style="display:none;">
        <label>1. ä¸Šå‚³ç”¨æˆ¶è¡¨ (Excel)</label>
        <input type="file" id="userTable" accept=".xlsx, .xls">
        <label style="margin-top:10px;">2. Google Sheet ID (å·²å…§å»º)</label>
        <input type="text" id="sheetId" value="19qYOvdspfs4LG_GxbiCFDQagem5fYRsS6sYMjwy9BFE" placeholder="è²¼ä¸Šè©¦ç®—è¡¨ ID">
    </div>

    <hr style="border:0.5px solid #eee; margin: 20px 0;">

    <div id="splitUI">
        <div class="row">
            <div class="field-group"><label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label><input type="number" id="headerRows" value="2" min="1"></div>
            <div class="field-group"><label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label><input type="number" id="rowsPerFile" value="0" min="0"></div>
        </div>
        <div class="checkbox-group" onclick="document.getElementById('doUnique').click()"><input type="checkbox" id="doUnique" checked onclick="event.stopPropagation()"><label>è‡ªå‹•å»é™¤é‡è¤‡</label></div>
        <div class="checkbox-group" onclick="document.getElementById('removeBlank').click()"><input type="checkbox" id="removeBlank" checked onclick="event.stopPropagation()"><label>è‡ªå‹•å‰”é™¤ç©ºç™½åˆ—</label></div>
    </div>

    <div id="transformUI" style="display:none;">
        <div class="info-box">ğŸ“ <strong>è½‰æ›è¦å‰‡ï¼š</strong>è‡ªå‹•å¿½ç•¥ A æª”å‰å…©åˆ—ï¼Œå°‡ U æ¬„ä½å°æ‡‰è‡³ deviceã€‚</div>
    </div>

    <div id="proxyUI" style="display:none;">
        <div class="info-box">ğŸŒ <strong>é›²ç«¯ä»£ç†åˆ†é…ï¼š</strong>
        â€¢ å·²é è¨­æ‚¨çš„ä»£ç†è¡¨ IDã€‚
        â€¢ æ”¯æ´æ ¼å¼ï¼šhost:port:user:passã€‚</div>
    </div>
    
    <button id="mainBtn" onclick="executeAction()">é–‹å§‹åŸ·è¡Œ</button>
    <div id="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
let currentMode = 'split';

// åˆ†é åˆ‡æ›ä¿®å¾©
function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0 && mode === 'split') || (i === 1 && mode === 'transform') || (i === 2 && mode === 'proxy'));
    });
    document.getElementById('commonUpload').style.display = (mode === 'proxy') ? 'none' : 'block';
    document.getElementById('proxyUpload').style.display = (mode === 'proxy') ? 'block' : 'none';
    document.getElementById('splitUI').style.display = (mode === 'split') ? 'block' : 'none';
    document.getElementById('transformUI').style.display = (mode === 'transform') ? 'block' : 'none';
    document.getElementById('proxyUI').style.display = (mode === 'proxy') ? 'block' : 'none';
}

function getMMDD() {
    const now = new Date();
    return String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
}

function isRowBlank(row) {
    return !row || row.length === 0 || row.every(cell => !cell || String(cell).trim() === "");
}

async function executeAction() {
    const log = document.getElementById('log');
    const dateStr = getMMDD();
    log.innerHTML = "âŒ› è™•ç†ä¸­...";
    try {
        if (currentMode === 'proxy') await handleCloudProxy(dateStr, log);
        else {
            const fileInput = document.getElementById('upload');
            if (!fileInput.files.length) throw new Error("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
            if (currentMode === 'split') await handleSplitMerge(fileInput, dateStr, log);
            else await handleTransform(fileInput, dateStr, log);
        }
    } catch (e) { log.innerHTML = `<span style="color:red">âŒ éŒ¯èª¤ï¼š${e.message}</span>`; }
}

async function handleSplitMerge(fileInput, dateStr, log) {
    const headerRows = parseInt(document.getElementById('headerRows').value) || 0;
    const rowsSetting = parseInt(document.getElementById('rowsPerFile').value) || 0;
    const doUnique = document.getElementById('doUnique').checked;
    const doRemoveBlank = document.getElementById('removeBlank').checked;
    let finalHeaders = [], combinedBody = [];

    for (let i = 0; i < fileInput.files.length; i++) {
        const data = await fileInput.files[i].arrayBuffer();
        const workbook = XLSX.read(data);
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        if (i === 0) finalHeaders = jsonData.slice(0, headerRows);
        let body = jsonData.slice(headerRows);
        if (doRemoveBlank) body = body.filter(r => !isRowBlank(r));
        combinedBody = combinedBody.concat(body);
    }
    if (doUnique) {
        const seen = new Set();
        combinedBody = combinedBody.filter(r => { const s = JSON.stringify(r); return seen.has(s) ? false : seen.add(s); });
    }
    const total = combinedBody.length;
    if (rowsSetting === 0 || total <= rowsSetting) {
        const ws = XLSX.utils.aoa_to_sheet([...finalHeaders, ...combinedBody]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        saveAs(new Blob([XLSX.write(wb, {type:'array'})]), `${dateStr}_${total}.xlsx`);
        log.innerHTML = `âœ… ä¸‹è¼‰å®Œæˆï¼šå…± ${total} ç­†ã€‚`;
    } else {
        const zip = new JSZip();
        for (let i = 0, count = 1; i < total; i += rowsSetting, count++) {
            const chunk = combinedBody.slice(i, i + rowsSetting);
            const ws = XLSX.utils.aoa_to_sheet([...finalHeaders, ...chunk]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            zip.file(`${dateStr}_${chunk.length}_${count}.xlsx`, XLSX.write(wb, {type:'array'}));
        }
        saveAs(await zip.generateAsync({type:"blob"}), `${dateStr}_split_${total}.zip`);
        log.innerHTML = `âœ… å·²åˆ†å‰²ä¸‹è¼‰ ZIPã€‚`;
    }
}

async function handleTransform(fileInput, dateStr, log) {
    const data = await fileInput.files[0].arrayBuffer();
    const workbook = XLSX.read(data);
    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
    const newHeaders = ["acc_id", "id", "group", "name", "remark", "platform", "username", "password", "fakey", "cookie", "proxytype", "ipchecker", "proxy", "proxyurl", "proxyid", "ip", "countrycode", "ua", "device"];
    const h = jsonData[0];
    const idx = { n: h.indexOf("çª—å£åç§°"), c: h.indexOf("Cookie"), r: h.indexOf("çª—å£å¤‡æ³¨"), u: 20 };
    let body = [];
    for (let i = 2; i < jsonData.length; i++) {
        const r = jsonData[i]; if (!r || isRowBlank(r)) continue;
        let nr = new Array(19).fill("");
        nr[3]=r[idx.n]||""; nr[4]=r[idx.r]||""; nr[9]=r[idx.c]||""; nr[18]=r[idx.u]||"";
        body.push(nr);
    }
    const ws = XLSX.utils.aoa_to_sheet([newHeaders, ...body]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    saveAs(new Blob([XLSX.write(wb, {type:'array'})]), `${dateStr}_${body.length}.xlsx`);
    log.innerHTML = `âœ… è½‰æ›å®Œæˆï¼š${body.length} ç­†ã€‚`;
}

// é›²ç«¯ä»£ç†åˆ†é…é‚è¼¯
async function handleCloudProxy(dateStr, log) {
    const userFile = document.getElementById('userTable').files[0];
    const sheetId = document.getElementById('sheetId').value.trim();
    if (!userFile || !sheetId) throw new Error("è«‹ä¸Šå‚³ç”¨æˆ¶è¡¨ï¼");
    
    // æŠ“å–é›²ç«¯ CSV
    const res = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`);
    if (!res.ok) throw new Error("ç„¡æ³•è®€å–è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèªæ¬Šé™æ˜¯å¦è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººå‡å¯æª¢è¦–ã€ã€‚");
    
    const csvText = await res.text();
    const proxyRows = XLSX.utils.sheet_to_json(XLSX.read(csvText, {type:'string'}).Sheets["Sheet1"] || XLSX.read(csvText, {type:'string'}).Sheets[Object.keys(XLSX.read(csvText, {type:'string'}).Sheets)[0]], { header: 1 });
    
    // è‡ªå‹•å°‹æ‰¾ä»£ç†æ ¼å¼æ¬„ä½
    let proxyIdx = 0;
    for (let j = 0; j < (proxyRows[0] || []).length; j++) {
        if (proxyRows.slice(0, 10).some(row => row[j] && String(row[j]).includes(':'))) {
            proxyIdx = j; break;
        }
    }
    const proxyList = proxyRows.map(r => r[proxyIdx]).filter(v => v && String(v).includes(':'));
    if (!proxyList.length) throw new Error("ä»£ç†è¡¨ä¸­æ‰¾ä¸åˆ°ç¬¦åˆ host:port æ ¼å¼çš„è³‡æ–™ï¼");

    const users = XLSX.utils.sheet_to_json(XLSX.read(await userFile.arrayBuffer()).Sheets[XLSX.read(await userFile.arrayBuffer()).SheetNames[0]]);
    const result = users.map((u, i) => {
        const p = proxyList[i % proxyList.length]; // å‡å‹»åˆ†é…
        return { ...u, proxy: p, "ä»£ç†ä¿¡æ¯": p, proxytype: 'socks5' }; // åŒæ™‚å¡«å…¥ proxy èˆ‡ä»£ç†ä¿¡æ¯
    });

    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(result), 'Assigned');
    saveAs(new Blob([XLSX.write(wb, {type:'array'})]), `${dateStr}_${result.length}_ip.xlsx`);
    log.innerHTML = `âœ… åˆ†é…æˆåŠŸï¼šå…± ${result.length} ç­†ã€‚`;
}
</script>
</body>
</html>
