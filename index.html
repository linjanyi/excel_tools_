<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Excel è¬èƒ½å·¥å…·ç®± - Google Sheet æ•´åˆç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #007bff; text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        .tab.active { color: #007bff; border-bottom: 3px solid #007bff; background: #f8fbff; }
        .field-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input[type="text"], input[type="number"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccd0d5; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; gap: 15px; }
        .row .field-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .checkbox-group input { width: 18px; height: 18px; margin-right: 10px; }
        .info-box { background: #e8f4fd; color: #2c3e50; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; border-left: 4px solid #3498db; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #218838; }
        #log { margin-top: 20px; font-size: 14px; color: #444; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff; white-space: pre-line; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="mainTitle">ğŸ“Š Excel è¬èƒ½å·¥å…·ç®±</h2>
    
    <div class="tabs">
        <div class="tab active" onclick="switchMode('split')">âœ‚ï¸ åˆ†å‰²/åˆä½µ</div>
        <div class="tab" onclick="switchMode('transform')">ğŸ”„ æ ¼å¼è½‰æ›</div>
        <div class="tab" onclick="switchMode('proxy')">ğŸŒ ä»£ç†åˆ†é…</div>
    </div>
    
    <div id="commonUpload" class="field-group">
        <label>1. ä¸Šå‚³æª”æ¡ˆ (å¯å¤šé¸)</label>
        <input type="file" id="upload" accept=".xlsx, .xls" multiple />
    </div>

    <div id="proxyUpload" class="field-group" style="display:none;">
        <div class="field-group">
            <label>1. ä¸Šå‚³ç”¨æˆ¶è¡¨ (Excel)</label>
            <input type="file" id="userTable" accept=".xlsx, .xls">
        </div>
        <div class="field-group">
            <label>2. Google Sheet ID (ä»£ç†è¡¨)</label>
            <input type="text" id="sheetId" placeholder="19qYOvdspfs4LG_GxbiCFDQagem5fYRsS6sYMjwy9BFE">
            <p style="font-size: 11px; color: #666; margin-top: 5px;">è«‹å°‡è©¦ç®—è¡¨æ¬Šé™è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººå‡å¯æª¢è¦–ã€</p>
        </div>
    </div>

    <div id="splitUI">
        <div class="row">
            <div class="field-group">
                <label>2. ä¿ç•™æ¨™é¡Œåˆ—æ•¸</label>
                <input type="number" id="headerRows" value="2" min="1" />
            </div>
            <div class="field-group">
                <label>3. æ¯ä»½ç­†æ•¸ (0=ä¸åˆ†å‰²)</label>
                <input type="number" id="rowsPerFile" value="0" min="0" />
            </div>
        </div>
        <div class="checkbox-group" onclick="document.getElementById('doUnique').click()">
            <input type="checkbox" id="doUnique" checked onclick="event.stopPropagation()">
            <label>è‡ªå‹•å»é™¤é‡è¤‡</label>
        </div>
    </div>

    <div id="transformUI" style="display:none;">
        <div class="info-box">
            <strong>ğŸ“ è½‰æ›è¦å‰‡ï¼š</strong><br>
            â€¢ A æª” U æ¬„ä½ â†’ <strong>device</strong> (æœ€å¾Œä¸€æ¬„)
        </div>
    </div>

    <div id="proxyUI" style="display:none;">
        <div class="info-box">
            <strong>ğŸŒ é›²ç«¯ä»£ç†åˆ†é…ï¼š</strong><br>
            â€¢ ç›´æ¥å¾ Google Sheet ç²å–æœ€æ–° IPã€‚<br>
            â€¢ æ¬„ä½åç¨±è«‹åŒ…å« 'proxy'ã€‚
        </div>
    </div>
    
    <button id="mainBtn" onclick="executeAction()">é–‹å§‹åŸ·è¡Œä¸¦å°å‡º</button>
    
    <div id="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
let currentMode = 'split';

function switchMode(mode) {
    currentMode = mode;
    const tabs = document.querySelectorAll('.tab');
    tabs[0].classList.toggle('active', mode === 'split');
    tabs[1].classList.toggle('active', mode === 'transform');
    tabs[2].classList.toggle('active', mode === 'proxy');

    document.getElementById('commonUpload').style.display = (mode === 'proxy') ? 'none' : 'block';
    document.getElementById('proxyUpload').style.display = (mode === 'proxy') ? 'block' : 'none';
    document.getElementById('splitUI').style.display = (mode === 'split') ? 'block' : 'none';
    document.getElementById('transformUI').style.display = (mode === 'transform') ? 'block' : 'none';
    document.getElementById('proxyUI').style.display = (mode === 'proxy') ? 'block' : 'none';
    document.getElementById('mainBtn').innerText = (mode === 'proxy') ? "å¾é›²ç«¯ç²å–ä¸¦åˆ†é…" : "é–‹å§‹è™•ç†ä¸¦å°å‡º";
}

function getMMDD() {
    const now = new Date();
    return String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
}

async function executeAction() {
    const log = document.getElementById('log');
    const dateStr = getMMDD();

    if (currentMode === 'proxy') {
        await handleCloudProxy(dateStr, log);
    } else {
        // ... åŸæœ‰çš„ split èˆ‡ transform é‚è¼¯ ...
        // (æ­¤è™•ç‚ºç¯€çœé•·åº¦ï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ï¼Œè«‹ä¿ç•™æ‚¨ä¹‹å‰çš„é‚è¼¯)
        const fileInput = document.getElementById('upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
        log.innerHTML = "âŒ› è™•ç†ä¸­...";
        if (currentMode === 'split') await handleSplitMerge(fileInput, dateStr, log);
        else await handleTransform(fileInput, dateStr, log);
    }
}

// ğŸŒ æ ¸å¿ƒï¼šå¾ Google Sheets ç²å–è³‡æ–™
async function handleCloudProxy(dateStr, log) {
    const userFile = document.getElementById('userTable').files[0];
    const sheetId = document.getElementById('sheetId').value.trim();

    if (!userFile || !sheetId) { alert('è«‹ä¸Šå‚³ç”¨æˆ¶è¡¨ä¸¦å¡«å…¥ Sheet IDï¼'); return; }

    log.innerHTML = "âŒ› æ­£åœ¨å¾ Google Sheet ç²å–ä»£ç†è³‡æ–™...";
    
    try {
        // åˆ©ç”¨ Google Sheets çš„å°å‡º CSV åŠŸèƒ½ï¼Œä¸éœ€ API Key
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
        const response = await fetch(url);
        if (!response.ok) throw new Error("ç„¡æ³•è®€å– Google Sheetï¼Œè«‹ç¢ºèª ID èˆ‡æ¬Šé™ã€‚");
        
        const csvText = await response.text();
        const proxyWorkbook = XLSX.read(csvText, { type: 'string' });
        const proxies = XLSX.utils.sheet_to_json(proxyWorkbook.Sheets[proxyWorkbook.SheetNames[0]]);

        const userData = await userFile.arrayBuffer();
        const userWorkbook = XLSX.read(userData);
        const users = XLSX.utils.sheet_to_json(userWorkbook.Sheets[userWorkbook.SheetNames[0]]);

        if (proxies.length === 0) { alert('ä»£ç†è¡¨ç‚ºç©ºï¼'); return; }

        const assignments = users.map((user, index) => {
            const randomProxy = proxies[index % proxies.length];
            let proxyIp = "";
            for (let key in randomProxy) {
                if (key.toLowerCase().includes('proxy')) { proxyIp = randomProxy[key]; break; }
            }
            return { ...user, proxy: proxyIp, proxytype: 'socks5' };
        });

        const workbook = XLSX.utils.book_new();
        const sheet = XLSX.utils.json_to_sheet(assignments);
        XLSX.utils.book_append_sheet(workbook, sheet, 'Assigned');
        const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        saveAs(new Blob([buffer]), `${dateStr}_${assignments.length}_ip.xlsx`);

        log.innerHTML = `âœ… é›²ç«¯åˆ†é…å®Œæˆï¼å…± ${assignments.length} ç­†è³‡æ–™ã€‚`;
    } catch (error) {
        log.innerHTML = `âŒ éŒ¯èª¤ï¼š${error.message}`;
    }
}

// ... è£œä¸Šå…¶é¤˜ handleSplitMerge èˆ‡ handleTransform ä»£ç¢¼å³å¯ ...
</script>
</body>
</html>
